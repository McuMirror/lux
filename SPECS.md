Lux Tech-Specs
==============

Lux is a protocol for the transmission of power and data from a host device to one or more nodes. It is capable of data rates approaching 3 megabits per second and supplying 30 Watts of power over distances of up to 100 feet. It is designed to be easy to implement and uses low-cost cabling and connectors.

Physical Layer
--------------

Lux is designed with a hub-and-spoke model in mind. Each lux universe must have exactly one master but may have an arbitrary number of nodes (limited only by the bandwidth of the bus.)

The master exposes one or more RJ-11 jacks (6p4c) and each node exposes one RJ-11 jack. Devices are connected with straight-through RJ-11 cables no longer than 100 feet and no thinner than 26 AWG per conductor.

The lux pinout is as follows:
 1. GND
 2. A
 3. B
 4. PWR

The voltage that nodes see between PWR and GND is nominally 48 volts, but may be as high as 54 volts or as low as 42 volts. The master or hub provides this power, and nodes consume it. The master should not output less than 48 volts or more than 54 volts. The drop in the cabling may be as large as 6 volts.

Nodes may be bus-powered or self-powered. A bus-powered node must not draw more than 650 mA from the bus. A self-powered node must use GND as reference for the data signals (i.e. must not be floating or at a different potential from the bus.)

RS-485 is used for the data lines. Nodes and masters should implement the recommended bias resistors and a termination resistor of 120 ohms, as well as a RS-485 compatible tranceiver capable of 3 megabit per second communcation. The serial protocol uses 3 megabaud, 8 data bits, 1 start bit, 1 stop bit, and no parity. The serial link is half-duplex.

Data link layer
---------------
Lux packets are encoded using consistent-overhead byte stuffing (COBS). A NULL (out-of-band 0 byte) is placed at the end of a packet. A packet consists of three parts:

<table><tr>
 <td>Destination Address</td>
 <td width="100%">Payload</td>
 <td>CRC</td>
</tr></table>

The destination address is four bytes. Nodes may have one or more addresses. One address may be used by multiple nodes (useful for multicast.) Because lux uses hubs, all traffic generated by the host will reach every node. Nodes should filter packets based on the address, and discard any packets not addressed to them. For the rest of this document, the address is assumed to be little-endian.

The payload can be between 0 and 1024 bytes long, inclusive (after COBS decoding.) The data contained in the payload is not specified by lux, except by way of the defacto standards described below. Packets with payloads longer than 1024 bytes should be discarded as corrupt.

After the payload comes a 32-bit CRC of the entire packet (after COBS decoding.) If the CRC does not check out, the packet should be discarded as corrupt.

Payload length is never explicitly stated. Instead, packets are null-teriminated. Payload length is defined as the packet length minus 8 bytes, to account for the address and checksum.

Packets shorter than 8 bytes should be discarded, though not necessarily marked as corrupt. An optional feature of this protocol is to start (as well as end) packets with a null. When this happens, the decoder may interpret the data between packets as packets. On an ideal busimplementing this two-zero variant, these packets are of length 0 and do not indicate an error condition.

MAC layer
---------

Lux uses a speak-when-spoken-to access control scheme. The master sends packets out to the nodes, and may optionally expect a response. If the master expects a response and does not receive one, it may re-send the packet after a timeout mutually agreed upon in advance by the node and the master. Nodes can only send data back to the master. Node should never spuriously send packets, as they may collide with packets originating from the master.

Due to the topology of the bus, packets originating from nodes will not necessarily reach other nodes. Nodes that are sending packets to the master should clear the destination field (set it to all zeros.) Nodes should never react to packets with this address.

De-facto standards
------------------

The following are not mandatory for implementing a correctly-functioning lux node. However, they are highly recommended to maintain compatibility between nodes.

Nodes should always accept packets on address 0xFFFFFFFF. That way, a node with an unknown or corrupt address filter can always be reached.

Nodes should respond to a packet with no payload (length-0 payload) with a string identifying the kind of node they are. This string should be unique enough so that the master can proceed with node-specific communcation, or give up if the string is unknown to the master.

Uninitialized nodes should assume address 0x80000000. That way, the master can "enumerate" new nodes by continuously sending zero-length packets to 0x80000000. When an unitialized node is found, it should be configured with a permanent address and stop listening on 0x80000000.
